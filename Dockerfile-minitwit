FROM ubuntu:18.04

# Updating packages
RUN sudo apt-get update

# ---------------------------------------
#          MySQL Setup
# ---------------------------------------

# Setting MySQL root user password root/root
RUN  debconf-set-selections <<< 'mysql-server mysql-server/root_password password root'
RUN  debconf-set-selections <<< 'mysql-server mysql-server/root_password_again password root'


# Installing packages
RUN sudo apt-get install -y mysql-server mysql-client

RUN sudo mysql -u root -proot -e "GRANT ALL PRIVILEGES ON *.* TO 'root'@'%' IDENTIFIED BY 'root'; FLUSH privileges;"
RUN sudo service mysql restart
# create client database
RUN sudo mysql -u root -proot -e "CREATE DATABASE minitwit;"


RUN echo "CLONING REPOSITORY"
RUN sudo git clone https://github.com/JesperFalkenberg/devops2021.git -b feature/deploy
RUN echo "INSTALLING MAVEN"
RUN sudo apt install maven -y
RUN cd devops2021/java-itu-minitwit/
RUN echo "BUILDING PROJECT"
RUN sudo mvn package
RUN cd target

RUN sudo java -jar java-itu-minitwit-1.0-SNAPSHOT.jar

RUN echo "================================================================="
RUN echo "=                            DONE                               ="
RUN echo "================================================================="
RUN echo "Navigate in your browser to:"
RUN THIS_IP=`hostname -I | cut -d" " -f1`
RUN echo "http://${THIS_IP}:4567"

EXPOSE 4567
