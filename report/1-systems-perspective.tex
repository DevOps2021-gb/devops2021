\section{System's perspective} \label{section:System perspective}
\todo{gå igennem alle ugers "afleveringer" og tjek vi har argumenteret for alt}
\subsection{Design}
The Minitwit application is a simple application allowing users to post messages, see messages posted by others and follow other users in order to specifically see what they post.

The application is implemented using Java with Spark and a MySQL database. Java was chosen since it is platform independent and a popular language, meaning that extensive documentation is available and it would be easy for a future team to inherit the code. Spark was chosen as it is similar to Flask which was used for the inherited Minitwit system and since it has a reasonable learning curve and is straight forward to use for an application of the size of Minitwit. The frontend consist of html templates connected with the backend using the template engine Jinjava, chosen to mimic the python Minitwit with minimal effort. 

MySQL was chosen for database since the relational model fits the system data well. \textcolor{red}{Why is it better than eg SQLite?}. \todo{Indexes?}\todo{Skal vi have design af db tables? eventuelt som et billede/screenshot? Ja det ville være godt med en kort beskrivelse af tables og model}

The ORM tool used is NORM, which is a lightweight ORM that does not require the complex markdown files that tools like Hibernate or JPA introduce. It is suitable for smaller projects with simple models and therefore for Minitwit.

Hibernate was implemented as a test to see if it would be a better fit since it is more complex but it turned out that the tool did not deliver on its promises, meaning that it only introduced more unnecessary complexity without adding any benefits. It furthermore complicated database joins that are needed for Minitwit. We decided to stick with NORM.

The application is hosted on DigitalOcean. Measures taken to ensure availability and for maintenance purposes, monitoring with Prometheus and Grafana and logging using an ELK-stack, are described in further sections.


\subsection{Architecture}

\hyperref[fig:componentDiagram]{Figure \ref{fig:componentDiagram}} shows the different components of the application.

\todo{TODO: MISSING TEXT ON EACH CONNECTOR.}
\begin{figure}[H]
    \centering
    \hspace*{-0.5in}
    \includegraphics[width=1.2\textwidth]{images/Diagrams-Development_view_component_diagram.jpg}
    \caption{Component diagram, development view}
    \label{fig:componentDiagram}
\end{figure}

\subsubsection{Main}
Main is the system's entrance point and allows specification of which database to use. Main starts monitoring and logging services and defines the number of threads to use. \hyperref[fig:classDiagramMain]{Figure \ref{fig:classDiagramMain}} presents a class diagram. \todo{stemmer det her diagram overens med connectorne i figur 1 egentlig?}
\begin{figure}[H]
    \centering
    \includegraphics[width=0.7\textwidth]{images/class_diagram_main.jpg}
    \caption{Class diagram main, logical view}
    \label{fig:classDiagramMain}
\end{figure}

\subsubsection{Utilities}
Utilities, shown in \hyperref[fig:classDiagramUtilities]{figure \ref{fig:classDiagramUtilities}}, contains helper methods like hashing, formatting dates and JSON, and houses Request, Response and Session wrapper objects to use with Spark.
\begin{figure}[H]
    \centering
    \includegraphics[width=1.0\textwidth]{images/class_diagram_utilities.jpg}
    \caption{Class diagram utilities, logical view}
    \label{fig:classDiagramUtilities}
\end{figure}
\todo{Eventuelt flyt de tre sidste klasser ned på en ny linje, så billedet kan gøres bredere = teksten nemmere at læse}

\subsubsection{Error handling}
Error handling contains objects used to wrap results of computations that can result in exceptions, allowing for better error handling and reduction of try-catch-statements. A class diagram is presented in  \hyperref[fig:classDiagramErrorhandling]{figure \ref{fig:classDiagramErrorhandling}}.
\begin{figure}[H]
    \centering
    \includegraphics[width=1.0\textwidth]{images/class_diagram_errorhandling.jpg}
    \caption{Class diagram errorhandling, logical view}
    \label{fig:classDiagramErrorhandling}
\end{figure}

\subsubsection{Controllers}
Controllers handles the endpoints the application provides by mapping post and get request to appropriate methods. The class diagram can be seen in \hyperref[fig:classDiagramControllers]{figure \ref{fig:classDiagramControllers}}.
\begin{figure}[H]
    \centering
    \includegraphics[width=1.0\textwidth]{images/class_diagram_controllers.jpg}
    \caption{Class diagram controllers, logical view}
    \label{fig:classDiagramControllers}
\end{figure}

\subsubsection{View}
View contains code for rendering and redirecting between pages of Minitwit. Pages are rendered html-templates. The class diagram can be seen in \hyperref[fig:classDiagramView]{figure \ref{fig:classDiagramView}}.\todo{Er det her ikke de forkerte metoder i diagrammet? Skal det ikke være renderTemplate og redirect?}
\begin{figure}[H]
    \centering
    \includegraphics[width=0.8\textwidth]{images/class_diagram_view.jpg}
    \caption{Class diagram view, logical view}
    \label{fig:classDiagramView}
\end{figure}

\subsubsection{Services}
Services includes functions executing requests and responses along with code for gathering and printing information to be used by the monitoring and logging services.
%Services includes code for maintenance, which uses Prometheus library to store the values Prometheus should collect, and the log service, which prints in a manner easy to filter for in Kibana. Services also includes functions executing the requests and responses.\\
Class diagram presented in \hyperref[fig:classDiagramServices]{figure \ref{fig:classDiagramServices}}.
 \begin{figure}[H]
    \centering
    \hspace*{-1.5in}
    \includegraphics[width=1.6\textwidth]{images/class_diagram_services.jpg}
    \caption{Class diagram services, logical view}
    \label{fig:classDiagramServices}
\end{figure}

\subsubsection{Repository}
Repository includes code for starting the database and executing queries needed by the services. Class diagram can be seen in \hyperref[fig:classDiagramRepository]{figure \ref{fig:classDiagramRepository}}.
\begin{figure}[H]
    \centering
    \hspace*{-1.3in}
    \includegraphics[width=1.55\textwidth]{images/class_diagram_repository.jpg}
    \caption{Class diagram repositories, logical view}
    \label{fig:classDiagramRepository}
\end{figure}

\subsubsection{Model}
Model contains classes used by NORM as templates for creating database entities. Class diagram can be seen in \hyperref[fig:classDiagramModel]{figure \ref{fig:classDiagramModel}}.\todo{forkert diagram}
\begin{figure}[H]
    \centering
    \includegraphics[width=0.7\textwidth]{images/class_diagram_model.jpg}
    \caption{Class diagram model, logical view}
    \label{fig:classDiagramModel}
\end{figure}

\subsubsection{Benchmark}
Benchmark is not in deployment and contains code to be run locally only. It is used for measuring the speed of different repository operations and was used to argue for speedups related to extensions to the database, e.g. when indexes was added.


\subsection{Dependencies }
\begin{itemize}
    \item \textbf{Spark Java}: A micro framework for creating web applications with minimal effort. %Suitable for the project size and gave us the freedom to structure the application how we wanted it.
    \item \textbf{jinjava}: Template engine based on django template syntax, used to render jinja templates.
    \item \textbf{PicoContainer}: General purpose IoC container.
    \item \textbf{NORM}: Lightweight ORM tool. %that doesn't require the complex markdown files that Hibernate, JPA etc. introduce. Suitable for smaller projects with simple models.
    \item \textbf{MySQL}: Relational database.% Chosen based on familiarity to team members and it's renowned reliability for how long it's been around.  
    \item \textbf{JUnit 5}: Most popular unit-testing framework.
    \item \textbf{Mockito}: Mocking framework with a simple API.
    \item \textbf{SLF4J}: Logging Facade for ELK stack. 
    \item \textbf{prometheus}: Prometheus JVM Client for introducing instrumenting such as gauges, counters and other metrics.
    \item \textbf{org.json}: Toolkit for JSON.
\end{itemize}
\subsubsection{Plugins}
\begin{itemize}
    \item \textbf{Maven}: Build automation tool used to manage Java project and its dependencies.
    \item \textbf{PMD}: Code analyzer, used to find common programming flaws like unused variables, unnecessary object creation etc. 
    \item \textbf{Forbidden API Checker}: Static code analysis that parses java byte code to find invocations of dangerous and deprecated method/class/fields signatures. 
    \item \textbf{SonarCloud}: Bug, Vulnerability and Code Smell detection tool with issue contextualization and remediation guidance. Used in our CI for Continuous code inspection.\footnote{\url{https://github.com/DevOps2021-gb/devops2021/wiki/Static-Analysis-Tools}}
\end{itemize}

\url{www.licensediscovery.io} was used to analyze Maven dependency licenses. As seen in figure \ref{fig:licenceDep} the strictest license that the majority of dependencies is ruled by is the Apache Software License Version 2. This is the license that we therefore went with.\footnote{\url{https://github.com/DevOps2021-gb/devops2021/blob/main/LICENSE.md}} 
\todo{Er det begrundelse nok? \textcolor{yellow}{kan ikke komme på mere at sige om det i hvert fald}}
\begin{figure}[!htb]
    \centering
    \includegraphics[scale=0.2]{images/LicenceDependencies.png}
    \caption{Overview of dependency licenses. Sub-dependencies included.}
    \label{fig:licenceDep}
\end{figure}
\todo{ryk billede i bilag eller til repository, det er umuligt at se hvad der står}

\subsection{Important interactions of subsystem}
\hyperref[fig:componentDiagram]{Figure \ref{fig:communicationDiagram}} shows the interaction between different parts of the system and between users and system.

Code is stored on GitHub, which developers pull and push to during development. When running the code locally, a local database should be used, called \texttt{minitwit}, which runs on port 3306 localhost with password and username "root". The repository contains a docker compose file for running the Minitwit stack locally which includes an empty MySQL database container.

GitHub actions analyzes the files pushed using SonarCloud. GitHub Actions deploys to a docker image and pulls down official Prometheus, Grafana, Filebeat, ElasticSearch, Kibana and Nginx images.

The images are all deployed on two DigitalOcean droplets, where the Minitwit containers utilize a remote DigitalOcean database. One droplet is the primary server and uses a floating IP. The other droplet is regarded as a backup and regularly checks through http whether the Minitwit service is responding successfully. If not, the backup droplet obtains the floating IP until the primary is responding as expected.\todo{skal vi have deployment diagram????}

The Kibana and Grafana images are for viewing maintenance and logging and the remaining four are for the ELK logging stack.

\begin{figure}[H]
    \centering
    \hspace*{-1.5in}
    \includegraphics[width=1.6\textwidth]{images/Diagrams-Process_view_communication_diagram.jpg}
    \caption{Communication diagram, process view}
    \label{fig:communicationDiagram}
\end{figure}

\subsection{Current state of system}
The system currently has a single known bug regarding the scaling of the system, see section \ref{issues-operation}. The main tool used for static analysis, Sonarcloud, reports the best rating, \textit{A}, on all measures, with 

\begin{itemize}
    \item 0 bugs
    \item 0 code vulnerabilities and 0 security hotspots
    \item 6 hours technical debt due to 63 code smells
    \item 0.0\% code duplication and 0 duplicated blocks
\end{itemize}

Out of the 63 code smells only 11 are major, critical or blockers and all 63 has been assessed as issues that can ignored.